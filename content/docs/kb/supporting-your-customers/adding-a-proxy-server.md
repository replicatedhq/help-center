+++
date = "2017-08-29T00:00:00Z"
lastmod = "2017-08-29T00:00:00Z"
title = "Adding a Proxy Server"
weight = "999999"
categories = [ "Knowledgebase", "Supporting Your Customers" ]
+++

The best way to configure Replicated to use a proxy server would be re-running the [Installation Script](https://help.replicated.com/docs/distributing-an-application/installing/)

### Proxy setting validation

To validate that the proxy setting is correct and works with Replicated try using curl to hit the echo IP endpoint

```shell
curl -x http://<proxy> https://api.replicated.com/market/v1/echo/ip
```

### Manually adding proxy server settings.

In the case of Replicated's installation script failing to properly add the proxy server settings we can do it manually.

### Systemd

We first need to [setup Docker](https://docs.docker.com/engine/admin/systemd/) with the proxy server configuration before configuring Replicated's proxy server settings.

After verifying Docker proxy settings are working correctly we will need to modify `/etc/sysconfig/replicated` and pass the variable `HTTP_PROXY into REPLICATED_OPTS`

```shell
cat /etc/sysconfig/replicated
RELEASE_CHANNEL=stable
PRIVATE_ADDRESS=10.138.0.2
SKIP_OPERATOR_INSTALL=0
REPLICATED_OPTS="-e LOG_LEVEL=info -e HTTP_PROXY=http://10.128.0.4:3128 -e DAEMON_TOKEN=9qB38BngNIb9aiw6Aq8JCQ57t8H4yYfC -e NODENAME=replicated-qa.internal" 
systemctl daemon-reload
```
The install may need to turn off proxy in Replicated and Docker to talk to our local registry. If you see any errors talking to the internal registry take the IP that it is trying to talk to and update

```shell
# add "-e NO_PROXY=172.17.0.1" to /etc/sysconfig/replicated at the end of REPLICATED_OPTS`
```
```shell
# update /etc/systemd/system/docker.service.d/http-proxy.conf and add a NO_PROXY block`
Environment="HTTP_PROXY=http://proxy.example.com:80/" "NO_PROXY=172.17.0.1"
```

```shell
# restart services
sudo systemctl daemon-reload
sudo systemctl restart docker
sudo systemctl restart replicated
sudo systemctl restart replicated-operator
```

### Upstart

Modify `/etc/default/docker` and add the environment variable http_proxy along with your proxy server settings.
```shell
cat /etc/default/docker
<-- cut -->
# Generated by replicated install script
export http_proxy="http://10.128.0.4:3128"
```

After verifying the Docker proxy setting are working correctly we will need to modify `/etc/default/replicated` and pass the variable `HTTP_PROXY into REPLICATED_OPTS`
```shell
cat /etc/default/replicated
RELEASE_CHANNEL=stable
PRIVATE_ADDRESS=10.140.0.2
SKIP_OPERATOR_INSTALL=0
REPLICATED_OPTS="-e LOG_LEVEL=info -e HTTP_PROXY=http://10.128.0.4:3128 -e DAEMON_TOKEN=ndUuf8kLs06ldzu0tMu7GcZ27 -e NODENAME=replicated-qa.internal"
```
If you have internal Docker registries that you need to contact without proxying you can specify them via the NO_PROXY environment variable.
```shell
cat /etc/sysconfig/replicated
RELEASE_CHANNEL=stable
PRIVATE_ADDRESS=10.138.0.2
SKIP_OPERATOR_INSTALL=0
REPLICATED_OPTS="-e HTTP_PROXY=http://10.128.0.4:3128 -e NO_PROXY=localhost,127.0.0.1,docker-registry.localnetwork -e LOG_LEVEL=info -e DAEMON_TOKEN=KAEj1FxnRc507Uk7yTZA68U5gaJ3JhL -e NODENAME=replicated-qa.internal"
docker inspect replicated
<-- cut -->
            "Env": [
                "LOCAL_ADDRESS=10.138.0.2",
                "RELEASE_CHANNEL=stable",
                "HTTP_PROXY=http://10.128.0.4:3128",
                "NO_PROXY=localhost,127.0.0.1,docker-registry.localnetwork",
                "LOG_LEVEL=info",
                "DAEMON_TOKEN=KAEj1FxnRc507Uk7yTZA68U5gaJ3JhL",
                "NODENAME=malcolm-getelk.c.replicated-qa.internal",
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
<-- cut -->
```

The install may need to turn off proxy in Docker. If you see any errors talking to the internal registry take the IP that it is trying to talk to and update

Update `/etc/default/docker` and add a NO_PROXY block i.e. `export no_proxy="10.128.0.4"`

Restart docker

```shell
sudo restart docker
```