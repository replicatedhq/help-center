+++
date = "2017-08-29T00:00:00Z"
lastmod = "2017-08-29T00:00:00Z"
title = "On-Prem Registry Certificates"
weight = "999999"
categories = [ "Knowledgebase", "Supporting Your Customers" ]
+++

### On-Prem Registry Certificates

Validate the certificate used by the Replicated on-prem registry against the docker certificate authority entry for it.

When Replicated is installed the replicated-operator drops a certificate authority (CA) file into /etc/docker/certs.d. The CA file is generated by the Replicated daemon and downloaded by the replicated-operator when it first connects, with it docker can securely pull images from the onprem Replicated registry.

### Download the certificate used by the internal registry

To validate the certificate we start by saving the certificate from the Replicated onprem registry which is hosted on port 9874. Make sure to update the IP address in the below example for use your IP address.

Find the Replicated onprem registry by looking in the docker certs.d folder

```shell
ls -la /etc/docker/certs.d
```
The local onprem registry will be configured to run on port 9874. Next we will download the onprem registry cert.

```shell
openssl s_client -showcerts -connect 10.128.0.5:9874 </dev/null
```

Copy the lines from (and including) "-BEGIN CERTIFICATE-" to "-END CERTIFICATE" to a file called "server.crt".

```shell
CONNECTED(00000003)
depth=0 C = USA, O = "Replicated, Inc.", OU = On-Prem Daemon, CN = 10.128.0.5
verify error:num=20:unable to get local issuer certificate
verify return:1
depth=0 C = USA, O = "Replicated, Inc.", OU = On-Prem Daemon, CN = 10.128.0.5
verify error:num=27:certificate not trusted
verify return:1
depth=0 C = USA, O = "Replicated, Inc.", OU = On-Prem Daemon, CN = 10.128.0.5
verify error:num=21:unable to verify the first certificate
verify return:1
---
Certificate chain
 0 s:/C=USA/O=Replicated, Inc./OU=On-Prem Daemon/CN=10.128.0.5
   i:/C=USA/O=Replicated-42458265/OU=CA
-----BEGIN CERTIFICATE-----
MIIDfzCCAmegAwIBAgIBAjANBgkqhkiG9w0BAQsFADA5MQwwCgYDVQQGEwNVU0Ex
HDAaBgNVBAoTE1JlcGxpY2F0ZWQtNDI0NTgyNjUxCzAJBgNVBAsTAkNBMCAXDTE2
MDkyMzIzMzgzNloYDzIxMTYwOTIzMjMzODM5WjBXMQwwCgYDVQQGEwNVU0ExGTAX
BgNVBAoTEFJlcGxpY2F0ZWQsIEluYy4xFzAVBgNVBAsTDk9uLVByZW0gRGFlbW9u
MRMwEQYDVQQDEwoxMC4xMjguMC41MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEA6U/E4ySG1bT76UzaBYvymgTU/KIZvx5/1kWQnLBK5hsF28KSSCzZ8wIR
Su4sWIHEC3YSQ1BKIFl4CWjsQvmj814mYuEXqZmMn4RyyN6j4kugHtg46Ccvh3eG
Ntz0UP/tu/mu80hgQPo91HoRqRl+1DFQQovYzILKO0wwZTToL1kt9U/JwSi0WG9E
X9PTc6zadALFqvqBVFZw9A/x22cHNt3/d+rSLG2MTqIcSNihmlIht2GlyImIdsNY
wH2riSr9Hu7HMx/ROh9o5jCtiJEwDXxFlsi5iAiC5SmxI1UWw9T5i16iNghpZyKR
o8cEp658jqrYj4aB1K1NB+9Kxvnz/QIDAQABo3IwcDAdBgNVHSUEFjAUBggrBgEF
BQcDAQYIKwYBBQUHAwIwHQYDVR0OBBYEFNLZiIse2qk16WeVEKoeQrskNjloMB8G
A1UdIwQYMBaAFPisEKa7t3PbJFmjmCN+ibUadFUjMA8GA1UdEQQIMAaHBAqAAAUw
DQYJKoZIhvcNAQELBQADggEBAHA3/QXfvKRRGpHd2rryBskjxw3jnelrP2v6B/+/
tTzLCbiCrSmUnpfSObIebZGlN3Wn6BbRKMkbd35h/BBsAIOBzHZXHtVSgcBBYnf2
zLDmiXzNntunT8oLHA8bm+wBUM1ztTayjy6rhWgZGoaCfjcMzTCe/JqyRmj8DOtA
KuxqT4tTOsnnWsLXG1pd+ZMxdzjCAXHtXdTHGKEDvluDoSB2hyQ/Ky6YPdubv71u
/8IqDcWUv27BugIBKrh5x/iTizXaONdoAQgLJVuZCpXXS1ONHx6bcTsuvF93B8vY
DHJfsY2nvDu/LPifNOFJwXTRubknLYdD1gNCrgmG35xcX14=
-----END CERTIFICATE-----
---
Server certificate
subject=/C=USA/O=Replicated, Inc./OU=On-Prem Daemon/CN=10.128.0.5
issuer=/C=USA/O=Replicated-42458265/OU=CA
---
No client certificate CA names sent
---
SSL handshake has read 1505 bytes and written 421 bytes
---
New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES128-GCM-SHA256
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES128-GCM-SHA256
    Session-ID: D22FC3D72A64DF1174FDC8A1C5CA4FCDEA0CB6A757F95F50ED0795AB238FCA80
    Session-ID-ctx: 
    Master-Key: DD4A968ECC7D3B1401395DEC2169D817F9CC85271D4611B13C6B93FA10A2C483C5E8FC1F2040B8CA60B21044E30887F0
    Key-Arg   : None
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket:
    0000 - 0f 44 53 ec e4 50 08 3b-52 b9 2f 44 e2 5c 32 61   .DS..P.;R./D.\2a
    0010 - 88 1d d7 4a ad f8 bc fa-48 49 21 ef 7c 43 94 7a   ...J....HI!.|C.z
    0020 - ba 3f 1a 69 18 27 63 27-18 05 5c 53 28 ca b9 27   .?.i.'c'..\S(..'
    0030 - 21 76 51 c4 d9 da 1c 13-c7 fd 72 8e c3 98 58 09   !vQ.......r...X.
    0040 - d4 6b e2 60 35 d0 9e b5-32 cd c8 b6 b2 63 14 83   .k.`5...2....c..
    0050 - bb fc be ad bc ef 36 a3-2e 0f bc 38 d6 5e 29 c7   ......6....8.^).
    0060 - 13 b2 ae 88 e8 94 99 37-2b 91 64 01 74 eb df eb   .......7+.d.t...
    0070 - d7 de 60 8d 33 91 dc dc-                          ..`.3...

    Start Time: 1474675085
    Timeout   : 300 (sec)
    Verify return code: 21 (unable to verify the first certificate)
---
DONE
```

### Validate the registry certificate against the local CA cert

Validate the certificate using openssl with the certificate the Replicated operator installed for docker. Remember to change the CAfile path to match your local server.

```shell
openssl verify -verbose -CAfile /etc/docker/certs.d/10.128.0.5\:9874/ca.crt server.crt 
server.crt: OK
```

### Diagnose issues by comparing the CA certificate to registry certificate

If the output shows OK the certificate is valid against the stored certificate authority (CA file).

To see the certificate information have openssl print it as text.

```shell
openssl x509 -in server.crt -text
```
```shell
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 2 (0x2)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=USA, O=Replicated-42458265, OU=CA
        Validity
            Not Before: Sep 23 23:38:36 2016 GMT
            Not After : Sep 23 23:38:39 2116 GMT
        Subject: C=USA, O=Replicated, Inc., OU=On-Prem Daemon, CN=10.128.0.5
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:e9:4f:c4:e3:24:86:d5:b4:fb:e9:4c:da:05:8b:
                    f2:9a:04:d4:fc:a2:19:bf:1e:7f:d6:45:90:9c:b0:
                    4a:e6:1b:05:db:c2:92:48:2c:d9:f3:02:11:4a:ee:
                    2c:58:81:c4:0b:76:12:43:50:4a:20:59:78:09:68:
                    ec:42:f9:a3:f3:5e:26:62:e1:17:a9:99:8c:9f:84:
                    72:c8:de:a3:e2:4b:a0:1e:d8:38:e8:27:2f:87:77:
                    86:36:dc:f4:50:ff:ed:bb:f9:ae:f3:48:60:40:fa:
                    3d:d4:7a:11:a9:19:7e:d4:31:50:42:8b:d8:cc:82:
                    ca:3b:4c:30:65:34:e8:2f:59:2d:f5:4f:c9:c1:28:
                    b4:58:6f:44:5f:d3:d3:73:ac:da:74:02:c5:aa:fa:
                    81:54:56:70:f4:0f:f1:db:67:07:36:dd:ff:77:ea:
                    d2:2c:6d:8c:4e:a2:1c:48:d8:a1:9a:52:21:b7:61:
                    a5:c8:89:88:76:c3:58:c0:7d:ab:89:2a:fd:1e:ee:
                    c7:33:1f:d1:3a:1f:68:e6:30:ad:88:91:30:0d:7c:
                    45:96:c8:b9:88:08:82:e5:29:b1:23:55:16:c3:d4:
                    f9:8b:5e:a2:36:08:69:67:22:91:a3:c7:04:a7:ae:
                    7c:8e:aa:d8:8f:86:81:d4:ad:4d:07:ef:4a:c6:f9:
                    f3:fd
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Subject Key Identifier: 
                D2:D9:88:8B:1E:DA:A9:35:E9:67:95:10:AA:1E:42:BB:24:36:39:68
            X509v3 Authority Key Identifier: 
                keyid:F8:AC:10:A6:BB:B7:73:DB:24:59:A3:98:23:7E:89:B5:1A:74:55:23

            X509v3 Subject Alternative Name: 
                IP Address:10.128.0.5
    Signature Algorithm: sha256WithRSAEncryption
         70:37:fd:05:df:bc:a4:51:1a:91:dd:da:ba:f2:06:c9:23:c7:
         0d:e3:9d:e9:6b:3f:6b:fa:07:ff:bf:b5:3c:cb:09:b8:82:ad:
         29:94:9e:97:d2:39:b2:1e:6d:91:a5:37:75:a7:e8:16:d1:28:
         c9:1b:77:7e:61:fc:10:6c:00:83:81:cc:76:57:1e:d5:52:81:
         c0:41:62:77:f6:cc:b0:e6:89:7c:cd:9e:db:a7:4f:ca:0b:1c:
         0f:1b:9b:ec:01:50:cd:73:b5:36:b2:8f:2e:ab:85:68:19:1a:
         86:82:7e:37:0c:cd:30:9e:fc:9a:b2:46:68:fc:0c:eb:40:2a:
         ec:6a:4f:8b:53:3a:c9:e7:5a:c2:d7:1b:5a:5d:f9:93:31:77:
         38:c2:01:71:ed:5d:d4:c7:18:a1:03:be:5b:83:a1:20:76:87:
         24:3f:2b:2e:98:3d:db:9b:bf:bd:6e:ff:c2:2a:0d:c5:94:bf:
         6e:c1:ba:02:01:2a:b8:79:c7:f8:93:8b:35:da:38:d7:68:01:
         08:0b:25:5b:99:0a:95:d7:4b:53:8d:1f:1e:9b:71:3b:2e:bc:
         5f:77:07:cb:d8:0c:72:5f:b1:8d:a7:bc:3b:bf:2c:f8:9f:34:
         e1:49:c1:74:d1:b9:b9:27:2d:87:43:d6:03:42:ae:09:86:df:
         9c:5c:5f:5e
-----BEGIN CERTIFICATE-----
MIIDfzCCAmegAwIBAgIBAjANBgkqhkiG9w0BAQsFADA5MQwwCgYDVQQGEwNVU0Ex
HDAaBgNVBAoTE1JlcGxpY2F0ZWQtNDI0NTgyNjUxCzAJBgNVBAsTAkNBMCAXDTE2
MDkyMzIzMzgzNloYDzIxMTYwOTIzMjMzODM5WjBXMQwwCgYDVQQGEwNVU0ExGTAX
BgNVBAoTEFJlcGxpY2F0ZWQsIEluYy4xFzAVBgNVBAsTDk9uLVByZW0gRGFlbW9u
MRMwEQYDVQQDEwoxMC4xMjguMC41MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
CgKCAQEA6U/E4ySG1bT76UzaBYvymgTU/KIZvx5/1kWQnLBK5hsF28KSSCzZ8wIR
Su4sWIHEC3YSQ1BKIFl4CWjsQvmj814mYuEXqZmMn4RyyN6j4kugHtg46Ccvh3eG
Ntz0UP/tu/mu80hgQPo91HoRqRl+1DFQQovYzILKO0wwZTToL1kt9U/JwSi0WG9E
X9PTc6zadALFqvqBVFZw9A/x22cHNt3/d+rSLG2MTqIcSNihmlIht2GlyImIdsNY
wH2riSr9Hu7HMx/ROh9o5jCtiJEwDXxFlsi5iAiC5SmxI1UWw9T5i16iNghpZyKR
o8cEp658jqrYj4aB1K1NB+9Kxvnz/QIDAQABo3IwcDAdBgNVHSUEFjAUBggrBgEF
BQcDAQYIKwYBBQUHAwIwHQYDVR0OBBYEFNLZiIse2qk16WeVEKoeQrskNjloMB8G
A1UdIwQYMBaAFPisEKa7t3PbJFmjmCN+ibUadFUjMA8GA1UdEQQIMAaHBAqAAAUw
DQYJKoZIhvcNAQELBQADggEBAHA3/QXfvKRRGpHd2rryBskjxw3jnelrP2v6B/+/
tTzLCbiCrSmUnpfSObIebZGlN3Wn6BbRKMkbd35h/BBsAIOBzHZXHtVSgcBBYnf2
zLDmiXzNntunT8oLHA8bm+wBUM1ztTayjy6rhWgZGoaCfjcMzTCe/JqyRmj8DOtA
KuxqT4tTOsnnWsLXG1pd+ZMxdzjCAXHtXdTHGKEDvluDoSB2hyQ/Ky6YPdubv71u
/8IqDcWUv27BugIBKrh5x/iTizXaONdoAQgLJVuZCpXXS1ONHx6bcTsuvF93B8vY
DHJfsY2nvDu/LPifNOFJwXTRubknLYdD1gNCrgmG35xcX14=
-----END CERTIFICATE-----
```
